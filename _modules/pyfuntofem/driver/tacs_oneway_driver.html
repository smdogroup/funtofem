
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyfuntofem.driver.tacs_oneway_driver &#8212; FUNtoFEM .0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinxdoc.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">FUNtoFEM .0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pyfuntofem.driver.tacs_oneway_driver</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyfuntofem.driver.tacs_oneway_driver</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of the package FUNtoFEM for coupled aeroelastic simulation</span>
<span class="sd">and design optimization.</span>

<span class="sd">Copyright (C) 2015 Georgia Tech Research Corporation.</span>
<span class="sd">Additional copyright (C) 2015 Kevin Jacobson, Jan Kiviaho and Graeme Kennedy.</span>
<span class="sd">All rights reserved.</span>

<span class="sd">FUNtoFEM is licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="sd">you may not use this software except in compliance with the License.</span>
<span class="sd">You may obtain a copy of the License at</span>

<span class="sd">   http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="sd">Unless required by applicable law or agreed to in writing, software</span>
<span class="sd">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="sd">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="sd">See the License for the specific language governing permissions and</span>
<span class="sd">limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># TACS one-way coupled drivers that use fixed fun3d aero loads</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TacsOnewayDriver&quot;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">pyfuntofem.interface.tacs_interface</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TacsInterface</span><span class="p">,</span>
    <span class="n">TacsSteadyInterface</span><span class="p">,</span>
    <span class="n">TacsUnsteadyInterface</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyfuntofem.interface.solver_manager</span> <span class="kn">import</span> <span class="n">SolverManager</span>
<span class="kn">from</span> <span class="nn">pyfuntofem.optimization.optimization_manager</span> <span class="kn">import</span> <span class="n">OptimizationManager</span>

<span class="kn">import</span> <span class="nn">importlib.util</span>

<span class="n">caps_loader</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;pyCAPS&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">caps_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># tacs loader not None check for this file anyways</span>
    <span class="kn">from</span> <span class="nn">tacs</span> <span class="kn">import</span> <span class="n">caps2tacs</span>

<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="TacsOnewayDriver"><a class="viewcode-back" href="../../../driver.html#pyfuntofem.driver.TacsOnewayDriver">[docs]</a><span class="k">class</span> <span class="nc">TacsOnewayDriver</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">solvers</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">transfer_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nprocs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">external_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        build the tacs analysis driver for shape/no shape change, assumes you have already primed the loads (see class method to assist with that)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        solvers: :class:`~interface.solver_manager.SolverManager`</span>
<span class="sd">            The various disciplinary solvers.</span>
<span class="sd">        model: :class:`~funtofem_model.FUNtoFEMmodel`</span>
<span class="sd">            The model containing the design data and the TACSmodel with tacsAIM wrapper inside (if using shape; otherwise can be None).</span>
<span class="sd">        transfer_settings: :class:`driver.TransferSettings`</span>
<span class="sd">        nprocs: int</span>
<span class="sd">            Number of processes that TACS is running on.</span>
<span class="sd">        external_shape: bool</span>
<span class="sd">            whether the tacs aim shape analysis is performed outside the class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solvers</span> <span class="o">=</span> <span class="n">solvers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">comm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="n">nprocs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_settings</span> <span class="o">=</span> <span class="n">transfer_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">structural</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">structural</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tacs_aim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tacs_aim</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">structural</span><span class="o">.</span><span class="n">tacs_aim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span> <span class="o">=</span> <span class="n">tacs_aim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_shape</span> <span class="o">=</span> <span class="n">external_shape</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_shape_init_transfer</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># store the shape variables list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_variables</span><span class="p">()</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">==</span> <span class="s2">&quot;shape&quot;</span>
        <span class="p">]</span>

        <span class="c1"># check for unsteady problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsteady</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unsteady</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="c1"># assertion checks for no shape change vs shape change</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_shape</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">tacs_aim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">external_shape</span>
            <span class="k">if</span> <span class="n">nprocs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># will error if nprocs not defined anywhere</span>
                <span class="n">nprocs</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">structural</span><span class="o">.</span><span class="n">nprocs</span>
            <span class="k">if</span> <span class="n">external_shape</span><span class="p">:</span>
                <span class="c1"># define properties needed for external shape paths</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dat_file_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_dir</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">caps_loader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tacs_aim</span><span class="p">,</span> <span class="n">caps2tacs</span><span class="o">.</span><span class="n">TacsAim</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="s2">&quot;Need to have ESP/CAPS pyCAPS package to use shape change&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># not change shape</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="p">,</span> <span class="n">TacsSteadyInterface</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="p">,</span> <span class="n">TacsUnsteadyInterface</span>
            <span class="p">)</span>

            <span class="c1"># transfer to fixed structural loads in case the user got only aero loads from the Fun3dOnewayDriver</span>
            <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">:</span>
                <span class="c1"># initializing transfer schemes is the responsibility of drivers with aerodynamic analysis since they come first</span>
                <span class="n">body</span><span class="o">.</span><span class="n">update_transfer</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                    <span class="c1"># perform disps transfer first to prevent seg fault</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">transfer_disps</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">transfer_temps</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
                    <span class="c1"># transfer aero to struct loads</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">transfer_loads</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">transfer_heat_flux</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">change_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_variables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">steady</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unsteady</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unsteady</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsteady</span>

<div class="viewcode-block" id="TacsOnewayDriver.prime_loads"><a class="viewcode-back" href="../../../driver.html#pyfuntofem.driver.TacsOnewayDriver.prime_loads">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">prime_loads</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">transfer_settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">external_shape</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to prime struct/aero loads for optimization over TACS analysis.</span>
<span class="sd">        Can use the Fun3dOnewayDriver or FUNtoFEMnlbgs driver to prime the loads</span>
<span class="sd">        If structural solver exists, it will transfer to fixed structural loads in __init__ construction</span>
<span class="sd">        of the TacsOnewayDriver class.</span>
<span class="sd">        If shape variables exist in the FUNtoFEMmodel, you need to have model.structural be a TacsModel</span>
<span class="sd">        and the TacsModel contains a TacsAim wrapper class. If shape variables exist, shape derivatives</span>
<span class="sd">        and shape analysis will be performed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        driver: :class:`Fun3dOnewayDriver` or :class:`~funtofem_nlbgs_driver.FUNtoFEMnlbgs`</span>
<span class="sd">            the fun3d oneway driver or coupled funtofem NLBGS driver</span>

<span class="sd">        Optional Parameters</span>
<span class="sd">        -------------------</span>
<span class="sd">        nprocs: int</span>
<span class="sd">            number of procs for tacs analysis, only need to give this if doing shape optimization</span>
<span class="sd">        transfer_settings: :class:`driver.TransferSettings`</span>
<span class="sd">            used for transferring fixed aero loads to struct loads, need to give this or it uses default</span>
<span class="sd">        external_shape: bool</span>
<span class="sd">            whether to do shape analysis with ESP/CAPS inside this driver or outside of it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">solve_forward</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">transfer_settings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">transfer_settings</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">transfer_settings</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">transfer_settings</span> <span class="o">=</span> <span class="n">transfer_settings</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">solvers</span><span class="p">,</span> <span class="n">driver</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">transfer_settings</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">external_shape</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TacsOnewayDriver.prime_loads_from_file"><a class="viewcode-back" href="../../../driver.html#pyfuntofem.driver.TacsOnewayDriver.prime_loads_from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">prime_loads_from_file</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">solvers</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">nprocs</span><span class="p">,</span>
        <span class="n">transfer_settings</span><span class="p">,</span>
        <span class="n">external_shape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to prime aero loads for optimization over tacs analysis with shape change and tacs aim</span>
<span class="sd">        Built from an aero loads file of a previous CFD analysis in FuntofemNlbgs driver (TODO : make uncoupled fluid solver features)</span>
<span class="sd">        The loads file is written from the FUNtoFEM model after a forward analysis of a flow solver</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str or path to aero loads file</span>
<span class="sd">            the filepath of the aerodynamic loads file from a previous CFD analysis (written from FUNtoFEM model)</span>
<span class="sd">        solvers: :class:`~interface.SolverManager`</span>
<span class="sd">            Solver Interface for CFD such as Fun3dInterface, Su2Interface, or test aero solver</span>
<span class="sd">        model : :class:`~model.FUNtoFEMmodel</span>
<span class="sd">        nprocs: int</span>
<span class="sd">            Number of processes that TACS is running on.</span>
<span class="sd">        transfer_settings: :class:`~transfer_settings.TransferSettings`</span>
<span class="sd">            Settings for transfer of state variables across aero and struct meshes</span>
<span class="sd">        tacs_aim: `caps2tacs.TacsAim`</span>
<span class="sd">            Interface object from TACS to ESP/CAPS, wraps the tacsAIM object.</span>
<span class="sd">        external_shape: bool</span>
<span class="sd">            whether the tacs aim shape analysis is performed outside this class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comm</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">comm</span>
        <span class="n">world_rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">world_rank</span> <span class="o">&lt;</span> <span class="n">nprocs</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">UNDEFINED</span>
        <span class="n">tacs_comm</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">world_rank</span><span class="p">)</span>

        <span class="c1"># initialize transfer settings</span>
        <span class="n">comm_manager</span> <span class="o">=</span> <span class="n">solvers</span><span class="o">.</span><span class="n">comm_manager</span>

        <span class="c1"># read in the loads from the file</span>
        <span class="n">loads_data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">read_aero_loads</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1"># initialize the transfer scheme then distribute aero loads</span>
        <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">initialize_transfer</span><span class="p">(</span>
                <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span>
                <span class="n">struct_comm</span><span class="o">=</span><span class="n">tacs_comm</span><span class="p">,</span>
                <span class="n">struct_root</span><span class="o">=</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">struct_root</span><span class="p">,</span>
                <span class="n">aero_comm</span><span class="o">=</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">aero_comm</span><span class="p">,</span>
                <span class="n">aero_root</span><span class="o">=</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">aero_root</span><span class="p">,</span>
                <span class="n">transfer_settings</span><span class="o">=</span><span class="n">transfer_settings</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">initialize_variables</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="n">body</span><span class="o">.</span><span class="n">_distribute_aero_loads</span><span class="p">(</span><span class="n">loads_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">solvers</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">nprocs</span><span class="o">=</span><span class="n">nprocs</span><span class="p">,</span>
            <span class="n">external_shape</span><span class="o">=</span><span class="n">external_shape</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hot_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OptimizationManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hot_start</span><span class="o">=</span><span class="n">hot_start</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tacs_comm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_shape</span><span class="p">:</span>
            <span class="n">world_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span>
            <span class="k">if</span> <span class="n">world_rank</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">world_rank</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">UNDEFINED</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">world_rank</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">tacs_comm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dat_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dat_file_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span><span class="o">.</span><span class="n">dat_file_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">analysis_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_shape</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span><span class="o">.</span><span class="n">analysis_dir</span>

<div class="viewcode-block" id="TacsOnewayDriver.input_paths"><a class="viewcode-back" href="../../../driver.html#pyfuntofem.driver.TacsOnewayDriver.input_paths">[docs]</a>    <span class="k">def</span> <span class="nf">input_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat_file_path</span><span class="p">,</span> <span class="n">analysis_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        receive path information if the user is handling the shape optimization externally</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dat_file_path: path object</span>
<span class="sd">            path to nastran_CAPS.dat file of the tacsAIM (which includes the bdf file)</span>
<span class="sd">        analysis_dir: path object</span>
<span class="sd">            path to write output f5 binary files from TACS analysis (which can be converted to vtk/tec files later)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dat_file_path</span> <span class="o">=</span> <span class="n">dat_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_dir</span> <span class="o">=</span> <span class="n">analysis_dir</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_transfer_fixed_aero_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        transfer fixed aero loads over to the new</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># loop over each body to copy and transfer loads for the new structure</span>
        <span class="n">shape_init_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape_init_transfer</span>
        <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">:</span>
            <span class="c1"># update the transfer schemes for the new mesh size</span>
            <span class="n">body</span><span class="o">.</span><span class="n">update_transfer</span><span class="p">()</span>

            <span class="n">ns</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">struct_nnodes</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">dtype</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">shape_init_transfer</span><span class="p">:</span>
                <span class="c1"># need to initialize transfer schemes again with tacs_comm</span>
                <span class="n">comm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span>
                <span class="n">comm_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvers</span><span class="o">.</span><span class="n">comm_manager</span>
                <span class="n">body</span><span class="o">.</span><span class="n">initialize_transfer</span><span class="p">(</span>
                    <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span>
                    <span class="n">struct_comm</span><span class="o">=</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">struct_comm</span><span class="p">,</span>
                    <span class="n">struct_root</span><span class="o">=</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">struct_root</span><span class="p">,</span>
                    <span class="n">aero_comm</span><span class="o">=</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">aero_comm</span><span class="p">,</span>
                    <span class="n">aero_root</span><span class="o">=</span><span class="n">comm_manager</span><span class="o">.</span><span class="n">aero_root</span><span class="p">,</span>
                    <span class="n">transfer_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transfer_settings</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># zero the initial struct loads and struct flux for each scenario</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="c1"># initialize new struct shape term for new ns</span>
                <span class="n">nf</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">count_adjoint_functions</span><span class="p">()</span>
                <span class="n">body</span><span class="o">.</span><span class="n">struct_shape_term</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span>
                <span class="p">)</span>

                <span class="c1"># initialize new elastic struct vectors</span>
                <span class="k">if</span> <span class="n">body</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

                <span class="c1"># initialize new struct heat flux</span>
                <span class="k">if</span> <span class="n">body</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">body</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">scenario</span><span class="o">.</span><span class="n">T_ref</span>
                    <span class="p">)</span>

                <span class="c1"># transfer disps to prevent seg fault if coming from Fun3dOnewayDriver</span>
                <span class="n">body</span><span class="o">.</span><span class="n">transfer_disps</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
                <span class="n">body</span><span class="o">.</span><span class="n">transfer_temps</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

                <span class="c1"># transfer the loads and heat flux from fixed aero loads to</span>
                <span class="c1"># the mesh for the new structural shape</span>
                <span class="n">body</span><span class="o">.</span><span class="n">transfer_loads</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
                <span class="n">body</span><span class="o">.</span><span class="n">transfer_heat_flux</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="TacsOnewayDriver.solve_forward"><a class="viewcode-back" href="../../../driver.html#pyfuntofem.driver.TacsOnewayDriver.solve_forward">[docs]</a>    <span class="k">def</span> <span class="nf">solve_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        forward analysis for the given shape and functionals</span>
<span class="sd">        assumes shape variables have already been changed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_shape</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_shape</span><span class="p">:</span>
                <span class="c1"># set the new shape variables into the model using update design to prevent CAPS_CLEAN errors</span>
                <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_variables</span><span class="p">()}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">structural</span><span class="o">.</span><span class="n">update_design</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span><span class="o">.</span><span class="n">setup_aim</span><span class="p">()</span>

                <span class="c1"># build the new structure geometry</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span><span class="o">.</span><span class="n">pre_analysis</span><span class="p">()</span>

            <span class="c1"># make the new tacs interface of the structural geometry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span> <span class="o">=</span> <span class="n">TacsInterface</span><span class="o">.</span><span class="n">create_from_bdf</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
                <span class="n">nprocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span><span class="p">,</span>
                <span class="n">bdf_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dat_file_path</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_dir</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># make a solvers object to hold structural solver since flow is no longer used</span>
            <span class="n">solvers</span> <span class="o">=</span> <span class="n">SolverManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">use_flow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">solvers</span><span class="o">.</span><span class="n">structural</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span>

            <span class="c1"># transfer the fixed aero loads</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_fixed_aero_loads</span><span class="p">()</span>
        <span class="c1"># end of change shape section</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_steady_forward</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsteady</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_unsteady_forward</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">)</span></div>

<div class="viewcode-block" id="TacsOnewayDriver.solve_adjoint"><a class="viewcode-back" href="../../../driver.html#pyfuntofem.driver.TacsOnewayDriver.solve_adjoint">[docs]</a>    <span class="k">def</span> <span class="nf">solve_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        solve the adjoint analysis for the given shape</span>
<span class="sd">        assumes the forward analysis for this shape has already been performed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># run the adjoint structural analysis</span>

        <span class="n">functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_functions</span><span class="p">()</span>

        <span class="c1"># Zero the derivative values stored in the function</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="n">func</span><span class="o">.</span><span class="n">zero_derivatives</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_steady_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsteady</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_unsteady_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">)</span>

        <span class="c1"># transfer loads adjoint since fa -&gt; fs has shape dependency</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_shape</span><span class="p">:</span>
            <span class="c1"># TODO : for unsteady this part might have to be included before extract coordinate derivatives?</span>
            <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">transfer_loads_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

        <span class="c1"># call get function gradients to store  the gradients from tacs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">get_function_gradients</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_shape</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_shape</span><span class="p">:</span>
            <span class="c1"># write the sensitivity file for the tacs AIM</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">write_sensitivity_file</span><span class="p">(</span>
                <span class="n">comm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span><span class="o">.</span><span class="n">sens_file_path</span><span class="p">,</span>
                <span class="n">discipline</span><span class="o">=</span><span class="s2">&quot;structural&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># run the tacs aim postAnalysis to compute the chain rule product</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span><span class="o">.</span><span class="n">post_analysis</span><span class="p">()</span>

            <span class="c1"># store the shape variables in the function gradients</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_shape_derivatives</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        <span class="c1"># end of change shape section</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_extract_coordinate_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;extract the coordinate derivatives at a given time step&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">get_coordinate_derivatives</span><span class="p">(</span>
            <span class="n">scenario</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span>
        <span class="p">)</span>

        <span class="c1"># add transfer scheme contributions</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">add_coordinate_derivative</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_get_shape_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get shape derivatives together from tacs aim</span>
<span class="sd">        and store the data in the funtofem model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># read shape gradients from tacs aim on root proc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_proc</span><span class="p">:</span>
            <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">direct_tacs_aim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_aim</span><span class="o">.</span><span class="n">aim</span>

            <span class="k">for</span> <span class="n">ifunc</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">functions</span><span class="p">):</span>
                <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_variables</span><span class="p">):</span>
                    <span class="n">derivative</span> <span class="o">=</span> <span class="n">direct_tacs_aim</span><span class="o">.</span><span class="n">dynout</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="n">full_name</span><span class="p">]</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">gradients</span><span class="p">[</span><span class="n">ifunc</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">derivative</span><span class="p">)</span>

        <span class="c1"># broadcast shape gradients to all other processors</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># store shape derivatives in funtofem model on all processors</span>
        <span class="k">for</span> <span class="n">ifunc</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">functions</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_variables</span><span class="p">):</span>
                <span class="n">derivative</span> <span class="o">=</span> <span class="n">gradients</span><span class="p">[</span><span class="n">ifunc</span><span class="p">][</span><span class="n">ivar</span><span class="p">]</span>
                <span class="n">func</span><span class="o">.</span><span class="n">add_gradient_component</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">derivative</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_solve_steady_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        solve the forward analysis of TACS analysis with aerodynamic loads</span>
<span class="sd">        and heat fluxes from previous analysis still retained</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># run the tacs forward analysis for no shape</span>
        <span class="c1"># zero all data to start fresh problem, u = 0, res = 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zero_tacs_data</span><span class="p">()</span>

        <span class="c1"># set functions and variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_variables</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_functions</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="c1"># run the forward analysis via iterate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="c1"># get functions to store the function values into the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">get_functions</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_solve_unsteady_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        solve the forward analysis of TACS analysis with aerodynamic loads</span>
<span class="sd">        and heat fluxes from previous analysis still retained</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># set functions and variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_variables</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_functions</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="c1"># run the forward analysis via iterate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="c1"># get functions to store the function values into the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">get_functions</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_solve_steady_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        solve the adjoint analysis of TACS analysis with aerodynamic loads</span>
<span class="sd">        and heat fluxes from previous analysis still retained</span>
<span class="sd">        Similar to funtofem_driver</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># zero adjoint data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zero_adjoint_data</span><span class="p">()</span>

        <span class="c1"># set functions and variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_variables</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_functions</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="c1"># zero all coupled adjoint variables in the body</span>
        <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">initialize_adjoint_variables</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

        <span class="c1"># initialize, run, and do post adjoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">initialize_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">iterate_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_coordinate_derivatives</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">post_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_solve_unsteady_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        solve the adjoint analysis of TACS analysis with aerodynamic loads</span>
<span class="sd">        and heat fluxes from previous analysis still retained</span>
<span class="sd">        Similar to funtofem_driver</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set functions and variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_variables</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">set_functions</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="c1"># zero all coupled adjoint variables in the body</span>
        <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="n">bodies</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">initialize_adjoint_variables</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

        <span class="c1"># initialize, run, and do post adjoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">initialize_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rstep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rstep</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">iterate_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">iterate_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_coordinate_derivatives</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">iterate_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">post_adjoint</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">bodies</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_zero_tacs_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        zero any TACS solution / adjoint data before running pure TACS</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">tacs_proc</span><span class="p">:</span>
            <span class="c1"># zero temporary solution data</span>
            <span class="c1"># others are zeroed out in the tacs_interface by default</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">zeroEntries</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">ext_force</span><span class="o">.</span><span class="n">zeroEntries</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">zeroEntries</span><span class="p">()</span>

            <span class="c1"># zero any scenario data</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="c1"># zero state data</span>
                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">scenario_data</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span><span class="o">.</span><span class="n">u</span>
                <span class="n">u</span><span class="o">.</span><span class="n">zeroEntries</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">setVariables</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_zero_adjoint_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">tacs_proc</span><span class="p">:</span>
            <span class="c1"># zero adjoint variable</span>
            <span class="k">for</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scenarios</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacs_interface</span><span class="o">.</span><span class="n">scenario_data</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span><span class="o">.</span><span class="n">psi</span>
                <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">psi</span><span class="p">:</span>
                    <span class="n">vec</span><span class="o">.</span><span class="n">zeroEntries</span><span class="p">()</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">FUNtoFEM .0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pyfuntofem.driver.tacs_oneway_driver</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, FUNtoFEM Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>