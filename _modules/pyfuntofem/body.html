
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyfuntofem.body &#8212; FUNtoFEM .0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">FUNtoFEM .0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pyfuntofem.body</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyfuntofem.body</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of the package FUNtoFEM for coupled aeroelastic simulation</span>
<span class="sd">and design optimization.</span>

<span class="sd">Copyright (C) 2015 Georgia Tech Research Corporation.</span>
<span class="sd">Additional copyright (C) 2015 Kevin Jacobson, Jan Kiviaho and Graeme Kennedy.</span>
<span class="sd">All rights reserved.</span>

<span class="sd">FUNtoFEM is licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="sd">you may not use this software except in compliance with the License.</span>
<span class="sd">You may obtain a copy of the License at</span>

<span class="sd">   http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="sd">Unless required by applicable law or agreed to in writing, software</span>
<span class="sd">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="sd">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="sd">See the License for the specific language governing permissions and</span>
<span class="sd">limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">funtofem</span> <span class="kn">import</span> <span class="n">TransferScheme</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.hermes_transfer</span> <span class="kn">import</span> <span class="n">HermesTransfer</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="Body"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body">[docs]</a><span class="k">class</span> <span class="nc">Body</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a body base class for FUNtoFEM. Can be used as is or as a</span>
<span class="sd">    parent class for bodies with shape parameterization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">analysis_type</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">boundary</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">fun3d</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">motion_type</span><span class="o">=</span><span class="s2">&quot;deform&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            name of the body</span>
<span class="sd">        id: int</span>
<span class="sd">            ID number of the body in the list of bodies in the model</span>
<span class="sd">        group: int</span>
<span class="sd">            group number for the body. Coupled variables defined in the body will be coupled with</span>
<span class="sd">            bodies in the same group</span>
<span class="sd">        boundary: int</span>
<span class="sd">            FUN3D boundary number associated with the body</span>
<span class="sd">        fun3d: bool</span>
<span class="sd">            whether or not you are using FUN3D. If true, the body class will auto-populate &#39;rigid_motion&#39; required by FUN3D</span>
<span class="sd">        motion_type: str</span>
<span class="sd">            the type of motion the body is undergoing. Possible options: &#39;deform&#39;,&#39;rigid&#39;,&#39;deform+rigid&#39;,&#39;rigid+deform&#39;</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :mod:`base` : Body inherits from Base</span>
<span class="sd">        :mod:`massoud_body` : example of class inheriting Body and adding shape parameterization</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.variable</span> <span class="kn">import</span> <span class="n">Variable</span> <span class="k">as</span> <span class="n">dv</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Body</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">=</span> <span class="n">analysis_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_root</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="n">boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">motion_type</span> <span class="o">=</span> <span class="n">motion_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">fun3d</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotRate&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotFreq&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotAmpl&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotOrgx&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotOrgy&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotOrgz&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">6</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotVecx&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotVecy&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;RotVecz&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">9</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;TrnRate&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;TrnFreq&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">11</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;TrnAmpl&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;TrnVecx&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">13</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;TrnVecy&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">14</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="s2">&quot;rigid_motion&quot;</span><span class="p">,</span> <span class="n">dv</span><span class="p">(</span><span class="s2">&quot;TrnVecz&quot;</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rigid_transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">TransferScheme</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># Set the data type to use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># shape parameterization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameterization</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># load and displacement transfer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># heat flux and temperature transfer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Number of nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Number of degrees of freedom on the thermal structural side of the transfer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">therm_xfer_ndof</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermal_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">3</span>  <span class="c1"># 0,1,2 for xyz and 3 for temp (mod 4) see tacs_interface.py</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_ref</span> <span class="o">=</span> <span class="mf">300.0</span>  <span class="c1"># reference temperature in Kelvin</span>

        <span class="c1"># Node locations u</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_X</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ID number of nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Aitken acceleration settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_init</span> <span class="o">=</span> <span class="mf">0.125</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_therm_init</span> <span class="o">=</span> <span class="mf">0.125</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_min</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_max</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aitken_init</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aitken_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aitken_therm_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">up_prev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">therm_up_prev</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># forward variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_shape_term</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rigid_transform</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_shape_term</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span>

<div class="viewcode-block" id="Body.initialize_struct_nodes"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.initialize_struct_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_struct_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct_X</span><span class="p">,</span> <span class="n">struct_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the structural mesh on any processors that have an instance</span>
<span class="sd">        of the structural solver.</span>

<span class="sd">        This function only needs to be called from processors that own an</span>
<span class="sd">        instance of the structural solver. This function is called before</span>
<span class="sd">        the transfer scheme is initialized.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        struct_X: np.ndarray</span>
<span class="sd">            The structural node locations</span>
<span class="sd">        struct_id:</span>
<span class="sd">            The nodal ids of each structural node</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">struct_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">struct_X</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct_X</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_id</span> <span class="o">=</span> <span class="n">struct_id</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.get_struct_nodes"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the structural node locations associated with this body</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_X</span></div>

<div class="viewcode-block" id="Body.get_num_struct_nodes"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_num_struct_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_struct_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of aerodynamic surface nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span></div>

<div class="viewcode-block" id="Body.get_struct_node_ids"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_node_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_node_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the structural node ids</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_id</span></div>

<div class="viewcode-block" id="Body.initialize_aero_nodes"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.initialize_aero_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_aero_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aero_X</span><span class="p">,</span> <span class="n">aero_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the aerodynamic surface mesh on any processors that have an</span>
<span class="sd">        instance of the aerodynamic solver</span>

<span class="sd">        This function only needs to be called from processors that own an</span>
<span class="sd">        instance of the aerodynamic solver. This function is called before</span>
<span class="sd">        the transfer scheme is initialized.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        aero_X: np.ndarray</span>
<span class="sd">            The aerodynamic node locations</span>
<span class="sd">        aero_id:</span>
<span class="sd">            The nodal ids of each aerodynamic node</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aero_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aero_X</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aero_X</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_id</span> <span class="o">=</span> <span class="n">aero_id</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.get_aero_nodes"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the aerodynamic node locations associated with this body</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_X</span></div>

<div class="viewcode-block" id="Body.get_num_aero_nodes"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_num_aero_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_aero_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the number of aerodynamic surface nodes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span></div>

<div class="viewcode-block" id="Body.get_aero_node_ids"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_node_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_node_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the aerodynamic node ids</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_id</span></div>

<div class="viewcode-block" id="Body.initialize_transfer"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.initialize_transfer">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_transfer</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comm</span><span class="p">,</span>
        <span class="n">struct_comm</span><span class="p">,</span>
        <span class="n">struct_root</span><span class="p">,</span>
        <span class="n">aero_comm</span><span class="p">,</span>
        <span class="n">aero_root</span><span class="p">,</span>
        <span class="n">transfer_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the load and displacement and/or thermal transfer scheme for this body</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comm: MPI.comm</span>
<span class="sd">            MPI communicator</span>
<span class="sd">        transfer_options: dictionary or list of dictionaries</span>
<span class="sd">            options for the load and displacement transfer scheme for the bodies</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If the user did not specify a transfer scheme default to MELD</span>
        <span class="k">if</span> <span class="n">transfer_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transfer_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;meld&quot;</span><span class="p">,</span> <span class="s2">&quot;isym&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;npts&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>

        <span class="c1"># Initialize the transfer and thermal transfer objects to None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">body_analysis_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_type</span>
        <span class="k">if</span> <span class="s2">&quot;analysis_type&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
            <span class="n">body_analysis_type</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;analysis_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Set up the transfer schemes based on the type of analysis set for this body</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">body_analysis_type</span> <span class="o">==</span> <span class="s2">&quot;aeroelastic&quot;</span>
            <span class="ow">or</span> <span class="n">body_analysis_type</span> <span class="o">==</span> <span class="s2">&quot;aerothermoelastic&quot;</span>
        <span class="p">):</span>

            <span class="c1"># Set up the load and displacement transfer schemes</span>
            <span class="k">if</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;hermes&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">HermesTransfer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_comm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_comm</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rbf&quot;</span><span class="p">:</span>
                <span class="n">basis</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">PY_THIN_PLATE_SPLINE</span>

                <span class="k">if</span> <span class="s2">&quot;basis function&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;basis function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">==</span> <span class="s2">&quot;thin plate spline&quot;</span>
                    <span class="p">):</span>
                        <span class="n">basis</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">PY_THIN_PLATE_SPLINE</span>
                    <span class="k">elif</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;basis function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                        <span class="n">basis</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">PY_GAUSSIAN</span>
                    <span class="k">elif</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;basis function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;multiquadric&quot;</span><span class="p">:</span>
                        <span class="n">basis</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">PY_MULTIQUADRIC</span>
                    <span class="k">elif</span> <span class="p">(</span>
                        <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;basis function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">==</span> <span class="s2">&quot;inverse multiquadric&quot;</span>
                    <span class="p">):</span>
                        <span class="n">basis</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">PY_INVERSE_MULTIQUADRIC</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown RBF basis function for body number&quot;</span><span class="p">)</span>
                        <span class="n">quit</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">pyRBF</span><span class="p">(</span>
                    <span class="n">comm</span><span class="p">,</span> <span class="n">struct_comm</span><span class="p">,</span> <span class="n">struct_root</span><span class="p">,</span> <span class="n">aero_comm</span><span class="p">,</span> <span class="n">aero_root</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="mi">1</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;meld&quot;</span><span class="p">:</span>
                <span class="c1"># defaults</span>
                <span class="n">isym</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># No symmetry</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Decay factor</span>
                <span class="n">num_nearest</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># Number of nearest neighbours</span>

                <span class="k">if</span> <span class="s2">&quot;isym&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">isym</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;isym&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;beta&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;npts&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">num_nearest</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;npts&quot;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">pyMELD</span><span class="p">(</span>
                    <span class="n">comm</span><span class="p">,</span>
                    <span class="n">struct_comm</span><span class="p">,</span>
                    <span class="n">struct_root</span><span class="p">,</span>
                    <span class="n">aero_comm</span><span class="p">,</span>
                    <span class="n">aero_root</span><span class="p">,</span>
                    <span class="n">isym</span><span class="p">,</span>
                    <span class="n">num_nearest</span><span class="p">,</span>
                    <span class="n">beta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;linearized meld&quot;</span><span class="p">:</span>
                <span class="c1"># defaults</span>
                <span class="n">isym</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">num_nearest</span> <span class="o">=</span> <span class="mi">200</span>

                <span class="k">if</span> <span class="s2">&quot;isym&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">isym</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;isym&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;beta&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;npts&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">num_nearest</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;npts&quot;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">pyLinearizedMELD</span><span class="p">(</span>
                    <span class="n">comm</span><span class="p">,</span>
                    <span class="n">struct_comm</span><span class="p">,</span>
                    <span class="n">struct_root</span><span class="p">,</span>
                    <span class="n">aero_comm</span><span class="p">,</span>
                    <span class="n">aero_root</span><span class="p">,</span>
                    <span class="n">isym</span><span class="p">,</span>
                    <span class="n">num_nearest</span><span class="p">,</span>
                    <span class="n">beta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;scheme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;beam&quot;</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;conn&quot;</span><span class="p">]</span>
                <span class="n">nelems</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;nelems&quot;</span><span class="p">]</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
                <span class="n">ndof</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;ndof&quot;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">xfer_ndof</span> <span class="o">=</span> <span class="n">ndof</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">pyBeamTransfer</span><span class="p">(</span>
                    <span class="n">comm</span><span class="p">,</span>
                    <span class="n">struct_comm</span><span class="p">,</span>
                    <span class="n">struct_root</span><span class="p">,</span>
                    <span class="n">aero_comm</span><span class="p">,</span>
                    <span class="n">aero_root</span><span class="p">,</span>
                    <span class="n">conn</span><span class="p">,</span>
                    <span class="n">nelems</span><span class="p">,</span>
                    <span class="n">order</span><span class="p">,</span>
                    <span class="n">ndof</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Unknown transfer scheme for body&quot;</span><span class="p">)</span>
                <span class="n">quit</span><span class="p">()</span>

        <span class="c1"># Set up the transfer schemes based on the type of analysis set for this body</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">body_analysis_type</span> <span class="o">==</span> <span class="s2">&quot;aerothermal&quot;</span>
            <span class="ow">or</span> <span class="n">body_analysis_type</span> <span class="o">==</span> <span class="s2">&quot;aerothermoelastic&quot;</span>
        <span class="p">):</span>
            <span class="c1"># Set up the load and displacement transfer schemes</span>

            <span class="k">if</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;thermal_scheme&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;meld&quot;</span><span class="p">:</span>
                <span class="c1"># defaults</span>
                <span class="n">isym</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">num_nearest</span> <span class="o">=</span> <span class="mi">200</span>

                <span class="k">if</span> <span class="s2">&quot;isym&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">isym</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;isym&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;beta&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;npts&quot;</span> <span class="ow">in</span> <span class="n">transfer_options</span><span class="p">:</span>
                    <span class="n">num_nearest</span> <span class="o">=</span> <span class="n">transfer_options</span><span class="p">[</span><span class="s2">&quot;npts&quot;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="o">=</span> <span class="n">TransferScheme</span><span class="o">.</span><span class="n">pyMELDThermal</span><span class="p">(</span>
                    <span class="n">comm</span><span class="p">,</span>
                    <span class="n">struct_comm</span><span class="p">,</span>
                    <span class="n">struct_root</span><span class="p">,</span>
                    <span class="n">aero_comm</span><span class="p">,</span>
                    <span class="n">aero_root</span><span class="p">,</span>
                    <span class="n">isym</span><span class="p">,</span>
                    <span class="n">num_nearest</span><span class="p">,</span>
                    <span class="n">beta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Unknown thermal transfer scheme for body&quot;</span><span class="p">)</span>
                <span class="n">quit</span><span class="p">()</span>

        <span class="c1"># Set the node locations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_transfer</span><span class="p">()</span>

        <span class="c1"># Initialize the load/displacement transfer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="c1"># Initialize the thermal transfer</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.update_transfer"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.update_transfer">[docs]</a>    <span class="k">def</span> <span class="nf">update_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the positions of the nodes in transfer schemes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">setStructNodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_X</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">setAeroNodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span><span class="o">.</span><span class="n">setStructNodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_X</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span><span class="o">.</span><span class="n">setAeroNodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_X</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.set_id"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.set_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **[model call]**</span>
<span class="sd">        Update the id number of the body or scenario</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id: int</span>
<span class="sd">           id number of the scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="k">for</span> <span class="n">vartype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">vartype</span><span class="p">]:</span>
                <span class="n">var</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="Body.add_variable"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.add_variable">[docs]</a>    <span class="k">def</span> <span class="nf">add_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vartype</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a new variable to the body&#39;s variable dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vartype: str</span>
<span class="sd">            type of variable</span>
<span class="sd">        var: Variable object</span>
<span class="sd">            variable to be added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Body</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">vartype</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span></div>

<div class="viewcode-block" id="Body.initialize_variables"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.initialize_variables">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the variables each time we run an analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We re-initialize aitken acceleration every time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aitken_is_initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span>
            <span class="n">na</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span>

            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span>
            <span class="n">na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span>

            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.initialize_adjoint_variables"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.initialize_adjoint_variables">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_adjoint_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the adjoint variables for the body.</span>

<span class="sd">        The adjoint variables in the body are not indexed by scenario.</span>
<span class="sd">        The variables are initialized once for each scenario and used until the</span>
<span class="sd">        adjoint computation is completed. For each new scenario a new set of</span>
<span class="sd">        adjoint variables are initialized. You cannot solve multiple adjoints for different</span>
<span class="sd">        scenarios at the same time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Count up the number of functions for this scenario</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">count_adjoint_functions</span><span class="p">()</span>

        <span class="c1"># Allocate the adjoint variables and internal body variables required</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span>
        <span class="n">na</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aero_shape_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">na</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct_shape_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span>
            <span class="n">na</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">na</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">na</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="c1"># There are two contributions to the term struct_disps_ajp. We compute and</span>
            <span class="c1"># store them separately and then add the contributions. These two contributions</span>
            <span class="c1"># are from the displacement and load transfer, respectively and are computed in</span>
            <span class="c1"># the transfer_disps_adjoint and transfer_loads_adjoint. Since they are computed</span>
            <span class="c1"># at different times and we don&#39;t impose a calling order/requirement we have to</span>
            <span class="c1"># store them separately.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_disps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_loads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span>
            <span class="n">na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">struct_flux_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aero_flux_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">na</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ns</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps_ajp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">na</span><span class="p">,</span> <span class="n">nf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.get_aero_disps"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_disps">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_disps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the displacements on the aerodynamic surface for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_disps"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_disps">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_disps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the displacements on the structure for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_aero_loads"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_loads">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the loads on the aerodynamic surface for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_loads"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_loads">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the loads on the structure for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_aero_temps"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_temps">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_temps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the temperatures on the aerodynamic surface for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_aero_heat_flux"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_heat_flux">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_heat_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the heat flux on the aerodynamic surface for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_temps"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_temps">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_temps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the temperatures on the structure for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_heat_flux"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_heat_flux">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_heat_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the heat flux on the structure for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.transfer_disps"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_disps">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_disps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer the displacements on the structural mesh to the aerodynamic mesh</span>
<span class="sd">        for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="n">aero_disps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="n">struct_disps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aero_disps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
                <span class="n">struct_disps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">transferDisps</span><span class="p">(</span><span class="n">struct_disps</span><span class="p">,</span> <span class="n">aero_disps</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.transfer_loads"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_loads">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer the aerodynamic loads on the aero surface mesh to loads on the</span>
<span class="sd">        structural mesh for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="n">aero_loads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="n">struct_loads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aero_loads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
                <span class="n">struct_loads</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">transferLoads</span><span class="p">(</span><span class="n">aero_loads</span><span class="p">,</span> <span class="n">struct_loads</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.transfer_temps"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_temps">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_temps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer the temperatures on the structural mesh to the aerodynamic mesh</span>
<span class="sd">        for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="n">struct_temps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="n">aero_temps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">struct_temps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
                <span class="n">aero_temps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span><span class="o">.</span><span class="n">transferTemp</span><span class="p">(</span><span class="n">struct_temps</span><span class="p">,</span> <span class="n">aero_temps</span><span class="p">)</span></div>

<div class="viewcode-block" id="Body.transfer_heat_flux"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_heat_flux">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_heat_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer the aerodynamic heat flux on the aero surface mesh to the heat flux on the</span>
<span class="sd">        structural mesh for the given scenario.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        time_index: int</span>
<span class="sd">            The time-index for time-dependent problems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">steady</span><span class="p">:</span>
                <span class="n">aero_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="n">struct_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aero_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
                <span class="n">struct_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_heat_flux</span><span class="p">[</span><span class="n">scenario</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span><span class="o">.</span><span class="n">transferFlux</span><span class="p">(</span><span class="n">aero_flux</span><span class="p">,</span> <span class="n">struct_flux</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.get_aero_loads_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_loads_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_loads_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the product of the load transfer adjoint variables with the derivative</span>
<span class="sd">        of the load transfer residuals with respect to the aerodynamic forces</span>

<span class="sd">        aero_loads_ajp = dL/dfA^{T} * psi_L</span>

<span class="sd">        The value of this product is computed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_aero_disps_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_disps_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_disps_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the product of the adjoint variables with the grid residuals with the</span>
<span class="sd">        derivative of the displacement at the aerodynamic surface nodes</span>

<span class="sd">        aero_disps_ajp = dG/duA^{T} * psi_G</span>

<span class="sd">        Note that this term is typically just the shape sensitivity</span>

<span class="sd">        dG/duA^{T} * psi_G = dG/dxA0 * psi_G</span>

<span class="sd">        This term must be set by the aerodynamic analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_disps_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_loads_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_loads_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_loads_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the product of the structural adjoint variables with the derivative of the</span>
<span class="sd">        structural residuals with respect to the structural loads.</span>

<span class="sd">        struct_loads_ajp = dS/dfS^{T} * psi_S</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_loads_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_disps_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_disps_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_disps_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the product of the displacement transfer adjoint variables with the derivative</span>
<span class="sd">        of the displacement transfer residuals w.r.t. the structural displacements plus the</span>
<span class="sd">        product of the load transfer adjoint variables with the derivative of the load</span>
<span class="sd">        transfer residuals w.r.t. the structural displacements.</span>

<span class="sd">        struct_disps_ajp = dD/duS^{T} * psi_D + dL/duS^{T} * psi_L</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_aero_heat_flux_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_heat_flux_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_heat_flux_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        aero_flux_ajp = dQ/dhA^{T} * psi_Q</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_flux_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_heat_flux_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_heat_flux_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_heat_flux_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        struct_flux_ajp = dS/dhS^{T} * psi_S</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_flux_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_aero_temps_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_temps_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_temps_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the</span>


<span class="sd">        aero_temps_ajp = dA/dtA^{T} * psi_A</span>

<span class="sd">        This variable must be set in an aerodynamic analysis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_temps_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.get_struct_temps_ajp"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_temps_ajp">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_temps_ajp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        struct_temps_ajp = dT/dtS^{T} * psi_T</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps_ajp</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Body.transfer_loads_adjoint"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_loads_adjoint">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_loads_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the adjoint computation for the load transfer operation. This code</span>
<span class="sd">        computes and stores the required Jacobian-adjoint products.</span>

<span class="sd">        Find the load transfer adjoint variables, psi_L, by solving the equation</span>

<span class="sd">        dL/dfS^{T} * psi_L = - dS/dfS^{T} * psi_S</span>

<span class="sd">        The right-hand-side term is stored as</span>

<span class="sd">        struct_loads_ajp = dS/dfS^{T} * psi_S</span>

<span class="sd">        and the Jacobian dL/dfS = I. After computing psi_L, the code computes the</span>
<span class="sd">        Jacobian-adjoint products</span>

<span class="sd">        aero_loads_ajp = dL/dfA^{T} * psi_L</span>
<span class="sd">        struct_disps_ajp_loads = dL/duS^{T} * psi_L</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nfunctions</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">count_adjoint_functions</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Contribute to the force integration and structural adjoint right-hand-sides</span>
            <span class="c1"># from the load transfer adjoint</span>
            <span class="n">temp_fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">temp_us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfunctions</span><span class="p">):</span>
                <span class="c1"># Solve for psi_L - Note that dL/dfS is the identity matrix. Ensure that</span>
                <span class="c1"># the vector is in contiguous memory.</span>
                <span class="n">psi_L</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_loads_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># Compute aero_loads_ajp = dL/dfa^{T} * psi_L</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">applydLdfATrans</span><span class="p">(</span><span class="n">psi_L</span><span class="p">,</span> <span class="n">temp_fa</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_loads_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_fa</span>

                <span class="c1"># Compute struct_disps_ajp_loads = dL/dus^{T} * psi_L</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">applydLduSTrans</span><span class="p">(</span><span class="n">psi_L</span><span class="p">,</span> <span class="n">temp_us</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_loads</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_us</span>

            <span class="c1"># Compute the update to the struct_disps_ajp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_disps</span><span class="p">[:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_loads</span><span class="p">[:]</span>
            <span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.transfer_disps_adjoint"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_disps_adjoint">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_disps_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the adjoint computation for the displacement transfer operations. This code</span>
<span class="sd">        computes and stores required Jacobian-adjoint products.</span>

<span class="sd">        Find the displacement transfer adjoint variables, psi_D, by solving the equation:</span>

<span class="sd">        dD/duA^{T} * psi_D = - dG/duA^{T} * psi_G</span>

<span class="sd">        Here the right-hand-side term is stored as</span>

<span class="sd">        aero_disps_ajp = dG/duA^{T} * psi_G</span>

<span class="sd">        The Jacobian dD/duA = I. After computing psi_D, the code computes the Jacobian-adjoint</span>
<span class="sd">        products</span>

<span class="sd">        struct_disps_ajp_disps = dD/duS^{T} * psi_D</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nfunctions</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">count_adjoint_functions</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfunctions</span><span class="p">):</span>
                <span class="c1"># Solve for psi_D - Note that dD/dua is the identity matrix</span>
                <span class="c1"># Copy the values into contiguous memory.</span>
                <span class="n">psi_D</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_disps_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># Set the dD/duS^{T} * psi_D product</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">applydDduSTrans</span><span class="p">(</span><span class="n">psi_D</span><span class="p">,</span> <span class="n">temp_us</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_disps</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_us</span>

            <span class="c1"># Compute the update to the struct_disps_ajp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_disps</span><span class="p">[:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_disps_ajp_loads</span><span class="p">[:]</span>
            <span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.transfer_heat_flux_adjoint"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_heat_flux_adjoint">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_heat_flux_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the adjoint computation for the heat flux transfer operations.</span>

<span class="sd">        This function first solves for the heat flux transfer adjoint, psi_Q by solving</span>
<span class="sd">        the equation</span>

<span class="sd">        dQ/dhS^{T} * psi_Q = - dS/dhS^{T} * psi_S</span>

<span class="sd">        Here the right-hand-side is stored as</span>

<span class="sd">        struct_flux_ajp = dS/dhS^{T} * psi_S</span>

<span class="sd">        Since dQ/dhS = I, the adjoint variables are psi_Q = - struct_flux_ajp.</span>

<span class="sd">        The code then computes</span>

<span class="sd">        aero_flux_ajp = dQ/dhA^{T} * psi_Q</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nfunctions</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">count_adjoint_functions</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfunctions</span><span class="p">):</span>
                <span class="n">psi_Q</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_flux_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># In the MELD interface code qA = hA so applydQdqATrans could/should?</span>
                <span class="c1"># be called applydQdhATrans</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span><span class="o">.</span><span class="n">applydQdqATrans</span><span class="p">(</span><span class="n">psi_Q</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_flux_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.transfer_temps_adjoint"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.transfer_temps_adjoint">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_temps_adjoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the adjoint computations for the thermal transfer operation.</span>

<span class="sd">        This function first solves for the temperature transfer adjoint psi_T, by solving</span>
<span class="sd">        the equation</span>

<span class="sd">        dT/dtA^{T} * psi_T = - dA/dtA^{T} * psi_A</span>

<span class="sd">        Here the right-hand-side is stored as</span>

<span class="sd">        aero_temps_ajp = dA/dtA^{T} * psi_A</span>

<span class="sd">        Since dT/dtA = I, then psi_T = - aero_temps_ajp.</span>

<span class="sd">        The code then computes</span>

<span class="sd">        struct_temps_ajp = dT/dtS^{T} * psi_T</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nfunctions</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">count_adjoint_functions</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfunctions</span><span class="p">):</span>
                <span class="n">psi_T</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_temps_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">thermal_transfer</span><span class="o">.</span><span class="n">applydTdtSTrans</span><span class="p">(</span><span class="n">psi_T</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_temps_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.get_aero_coordinate_derivatives"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_aero_coordinate_derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">get_aero_coordinate_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the coordinate derivatives for the functions with respect to the</span>
<span class="sd">        aerodynamic surface nodes</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_shape_term</span></div>

<div class="viewcode-block" id="Body.get_struct_coordinate_derivatives"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.get_struct_coordinate_derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">get_struct_coordinate_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the coordinate derivatives for the functions with respect to the</span>
<span class="sd">        structural nodes</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_shape_term</span></div>

<div class="viewcode-block" id="Body.add_coordinate_derivative"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.add_coordinate_derivative">[docs]</a>    <span class="k">def</span> <span class="nf">add_coordinate_derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the coordinate derivatives for each function of interest to the aerodynamic</span>
<span class="sd">        and structural surface nodes - stored in aero_shape_term and struct_shape_term, respectively</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: :class:`~scenario.Scenario`</span>
<span class="sd">            The current scenario</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nfunctions</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">count_adjoint_functions</span><span class="p">()</span>

            <span class="c1"># Aerodynamic coordinate derivatives</span>
            <span class="n">temp_xa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aero_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">temp_xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfunctions</span><span class="p">):</span>
                <span class="c1"># Solve for psi_L - Note that dL/dfS is the identity matrix. Ensure that</span>
                <span class="c1"># the vector is in contiguous memory.</span>
                <span class="n">psi_L</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_loads_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">applydLdxA0</span><span class="p">(</span><span class="n">psi_L</span><span class="p">,</span> <span class="n">temp_xa</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_shape_term</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp_xa</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">applydLdxS0</span><span class="p">(</span><span class="n">psi_L</span><span class="p">,</span> <span class="n">temp_xs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_shape_term</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp_xs</span>

                <span class="c1"># Solve for psi_D - Note that dD/dua is the identity matrix</span>
                <span class="c1"># Copy the values into contiguous memory.</span>
                <span class="n">psi_D</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_disps_ajp</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">applydDdxA0</span><span class="p">(</span><span class="n">psi_D</span><span class="p">,</span> <span class="n">temp_xa</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aero_shape_term</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp_xa</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">applydDdxS0</span><span class="p">(</span><span class="n">psi_D</span><span class="p">,</span> <span class="n">temp_xs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">struct_shape_term</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp_xs</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.aitken_relax"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.aitken_relax">[docs]</a>    <span class="k">def</span> <span class="nf">aitken_relax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-13</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Aitken relaxation for the displacements set in the</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">aitken_is_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_init</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aitken_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct_nnodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aitken_is_initialized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">struct_disps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_struct_disps</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">struct_disps</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">aitken_vec</span>
            <span class="n">norm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">up</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_update</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>

            <span class="c1"># Only update theta if the displacements changed</span>
            <span class="k">if</span> <span class="n">norm2</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="c1"># Compute the tentative theta value</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">up</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_update</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm2</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_max</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_min</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># handle the min/max for complex step</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">==</span> <span class="nb">complex</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="mf">0.0</span><span class="n">j</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">aitken_vec</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">*</span> <span class="n">up</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_update</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">up</span><span class="p">[:]</span>
            <span class="n">struct_disps</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aitken_vec</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">aitken_adjoint_relax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-13</span><span class="p">):</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Body.collect_coordinate_derivatives"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.collect_coordinate_derivatives">[docs]</a>    <span class="k">def</span> <span class="nf">collect_coordinate_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">discipline</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the sensitivity files for the aerodynamic and structural meshes on</span>
<span class="sd">        the root processor.</span>

<span class="sd">        This code collects the sensitivities from each processor and collects the</span>
<span class="sd">        result to the root node.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">discipline</span> <span class="o">==</span> <span class="s2">&quot;aerodynamic&quot;</span> <span class="ow">or</span> <span class="n">discipline</span> <span class="o">==</span> <span class="s2">&quot;flow&quot;</span> <span class="ow">or</span> <span class="n">discipline</span> <span class="o">==</span> <span class="s2">&quot;aero&quot;</span><span class="p">:</span>
            <span class="n">all_aero_ids</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_id</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>
            <span class="n">all_aero_shape</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aero_shape_term</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>

            <span class="n">aero_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">aero_shape</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
                <span class="c1"># Discard any entries that are None</span>
                <span class="n">aero_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_aero_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">aero_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

                <span class="n">aero_shape</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_aero_shape</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">aero_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aero_shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">aero_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">aero_shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aero_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aero_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">aero_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">aero_shape</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aero_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">aero_ids</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">aero_ids</span><span class="p">,</span> <span class="n">aero_shape</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">discipline</span> <span class="o">==</span> <span class="s2">&quot;structures&quot;</span>
            <span class="ow">or</span> <span class="n">discipline</span> <span class="o">==</span> <span class="s2">&quot;structural&quot;</span>
            <span class="ow">or</span> <span class="n">discipline</span> <span class="o">==</span> <span class="s2">&quot;struct&quot;</span>
        <span class="p">):</span>
            <span class="n">all_struct_ids</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_id</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>
            <span class="n">all_struct_shape</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">struct_shape_term</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>

            <span class="n">struct_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">struct_shape</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
                <span class="c1"># Discard any entries that are None</span>
                <span class="n">struct_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_struct_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">struct_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

                <span class="n">struct_shape</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_struct_shape</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">struct_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct_shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">struct_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">struct_shape</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">struct_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">struct_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">struct_shape</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">struct_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">struct_ids</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">struct_ids</span><span class="p">,</span> <span class="n">struct_shape</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.initialize_shape_parameterization"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.initialize_shape_parameterization">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_shape_parameterization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **[driver call]**</span>
<span class="sd">        Create the map of structural node locations since TACS doesn&#39;t give us global id numbers</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.update_shape"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.update_shape">[docs]</a>    <span class="k">def</span> <span class="nf">update_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">complex_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **[driver call]**</span>
<span class="sd">        perturbs the shape of the body based on the body&#39;s shape variables and update the meshes</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        complex_run: bool</span>
<span class="sd">            whether or not the run is complex mode</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Body.shape_derivative"><a class="viewcode-back" href="../../model.html#pyfuntofem.body.Body.shape_derivative">[docs]</a>    <span class="k">def</span> <span class="nf">shape_derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **[driver call]**</span>
<span class="sd">        Calculates the shape derivative given the coordinate derivatives</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        scenario: scenario object</span>
<span class="sd">            The current scenario</span>
<span class="sd">        offset: int</span>
<span class="sd">            function offset number</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span></div></div>

    <span class="c1"># def _aitken_adjoint_relax(self, scenario):</span>
    <span class="c1">#     nfunctions = scenario.count_adjoint_functions()</span>
    <span class="c1">#     if self.aitken_init:</span>
    <span class="c1">#         self.aitken_init = False</span>

    <span class="c1">#         # initialize the &#39;previous update&#39; to zero</span>
    <span class="c1">#         self.up_prev = []</span>
    <span class="c1">#         self.aitken_vec = []</span>
    <span class="c1">#         self.theta = []</span>

    <span class="c1">#         # initialize the &#39;previous update&#39; to zero</span>
    <span class="c1">#         self.therm_up_prev = []</span>
    <span class="c1">#         self.aitken_therm_vec = []</span>
    <span class="c1">#         self.theta_therm = []</span>

    <span class="c1">#         for ibody, body in enumerate(self.model.bodies):</span>
    <span class="c1">#             if body.transfer is not None:</span>
    <span class="c1">#                 up_prev_body = []</span>
    <span class="c1">#                 aitken_vec_body = []</span>
    <span class="c1">#                 theta_body = []</span>
    <span class="c1">#                 for func in range(nfunctions):</span>
    <span class="c1">#                     up_prev_body.append(</span>
    <span class="c1">#                         np.zeros(</span>
    <span class="c1">#                             body.struct_nnodes * body.xfer_ndof,</span>
    <span class="c1">#                             dtype=TransferScheme.dtype,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>
    <span class="c1">#                     aitken_vec_body.append(</span>
    <span class="c1">#                         np.zeros(</span>
    <span class="c1">#                             body.struct_nnodes * body.xfer_ndof,</span>
    <span class="c1">#                             dtype=TransferScheme.dtype,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>
    <span class="c1">#                     theta_body.append(self.theta_init)</span>
    <span class="c1">#                 self.up_prev.append(up_prev_body)</span>
    <span class="c1">#                 self.aitken_vec.append(aitken_vec_body)</span>
    <span class="c1">#                 self.theta.append(theta_body)</span>

    <span class="c1">#             if body.thermal_transfer is not None:</span>
    <span class="c1">#                 up_prev_body = []</span>
    <span class="c1">#                 aitken_therm_vec_body = []</span>
    <span class="c1">#                 theta_body = []</span>
    <span class="c1">#                 for func in range(nfunctions):</span>
    <span class="c1">#                     up_prev_body.append(</span>
    <span class="c1">#                         body.T_ref</span>
    <span class="c1">#                         * np.ones(</span>
    <span class="c1">#                             body.struct_nnodes * body.therm_xfer_ndof,</span>
    <span class="c1">#                             dtype=TransferScheme.dtype,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>
    <span class="c1">#                     aitken_therm_vec_body.append(</span>
    <span class="c1">#                         body.T_ref</span>
    <span class="c1">#                         * np.ones(</span>
    <span class="c1">#                             body.struct_nnodes * body.therm_xfer_ndof,</span>
    <span class="c1">#                             dtype=TransferScheme.dtype,</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     )</span>
    <span class="c1">#                     theta_body.append(self.theta_therm_init)</span>
    <span class="c1">#                 self.therm_up_prev.append(up_prev_body)</span>
    <span class="c1">#                 self.aitken_therm_vec.append(aitken_therm_vec_body)</span>
    <span class="c1">#                 self.theta_therm.append(theta_body)</span>

    <span class="c1">#     # do the Aitken update</span>
    <span class="c1">#     for ibody, body in enumerate(self.model.bodies):</span>
    <span class="c1">#         if body.struct_nnodes &gt; 0:</span>
    <span class="c1">#             if body.transfer is not None:</span>
    <span class="c1">#                 for func in range(nfunctions):</span>
    <span class="c1">#                     up = body.psi_S[:, func] - self.aitken_vec[ibody][func]</span>
    <span class="c1">#                     norm2 = np.linalg.norm(up - self.up_prev[ibody][func]) ** 2.0</span>

    <span class="c1">#                     # Only update theta if the vector changed</span>
    <span class="c1">#                     if norm2 &gt; 1e-13:</span>
    <span class="c1">#                         self.theta[ibody][func] *= (</span>
    <span class="c1">#                             1.0</span>
    <span class="c1">#                             - (up - self.up_prev[ibody][func]).dot(up)</span>
    <span class="c1">#                             / np.linalg.norm(up - self.up_prev[ibody][func]) ** 2.0</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                         self.theta[ibody][func] = np.max(</span>
    <span class="c1">#                             (</span>
    <span class="c1">#                                 np.min((self.theta[ibody][func], self.theta_max)),</span>
    <span class="c1">#                                 self.theta_min,</span>
    <span class="c1">#                             )</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     self.aitken_vec[ibody][func] += self.theta[ibody][func] * up</span>
    <span class="c1">#                     self.up_prev[ibody][func] = up[:]</span>
    <span class="c1">#                     body.psi_S[:, func] = self.aitken_vec[ibody][func][:]</span>

    <span class="c1">#             if body.thermal_transfer is not None:</span>
    <span class="c1">#                 for func in range(nfunctions):</span>
    <span class="c1">#                     up = body.psi_T_S[:, func] - self.aitken_therm_vec[ibody][func]</span>
    <span class="c1">#                     norm2 = (</span>
    <span class="c1">#                         np.linalg.norm(up - self.therm_up_prev[ibody][func]) ** 2.0</span>
    <span class="c1">#                     )</span>

    <span class="c1">#                     # Only update theta if the vector changed</span>
    <span class="c1">#                     if norm2 &gt; 1e-13:</span>
    <span class="c1">#                         self.theta_therm[ibody][func] *= (</span>
    <span class="c1">#                             1.0</span>
    <span class="c1">#                             - (up - self.therm_up_prev[ibody][func]).dot(up)</span>
    <span class="c1">#                             / np.linalg.norm(up - self.therm_up_prev[ibody][func])</span>
    <span class="c1">#                             ** 2.0</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                         self.theta_therm[ibody][func] = np.max(</span>
    <span class="c1">#                             (</span>
    <span class="c1">#                                 np.min(</span>
    <span class="c1">#                                     (self.theta_therm[ibody][func], self.theta_max)</span>
    <span class="c1">#                                 ),</span>
    <span class="c1">#                                 self.theta_min,</span>
    <span class="c1">#                             )</span>
    <span class="c1">#                         )</span>
    <span class="c1">#                     self.aitken_therm_vec[ibody][func] += (</span>
    <span class="c1">#                         self.theta_therm[ibody][func] * up</span>
    <span class="c1">#                     )</span>
    <span class="c1">#                     self.therm_up_prev[ibody][func] = up[:]</span>
    <span class="c1">#                     body.psi_T_S[:, func] = self.aitken_therm_vec[ibody][func][:]</span>

    <span class="c1">#     return</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">FUNtoFEM .0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pyfuntofem.body</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, FUNtoFEM Developers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
    </div>
  </body>
</html>